## DNS知识总览

DNS是网络里面最基础的服务，我们应该熟悉所有相关概念

### Top-Level Domain 顶级域名 
顶级域名又称TLD，是互联网DNS等级之中的最高级的域，它保存于**DNS根域的名字空间**中。
顶级域名是域名的最后一个部分，即是域名最后一点之后的字母，例如在example.com这个域名中，顶级域是.com（或.COM），大小写视为相同。

顶级域名是指域名中的最高层级。这个部分是由ICANN（互联网名称与数字地址分配机构）
进行管理分配的，通过域名注册商在TLD下分发。

### Host 主机
有了域名，你就可以定义独立的host主机，来通过域名访问不同的计算机和服务。
举个例子，大多数域名拥有者会让他们的域名既能通过 (example.com)访问也能通过host主机定义的"www"（www.example.com）来访问。
你也可以定义其他host主机名。比如：你可以定义api这个host，通过api.example.com来访问API

> 对于一个域名它底下的host名称可以随意只要保证在该域名下唯一就可以

### SubDomain 子域名
和host主机名相关的一个主题就是子域名。

DNS的有层级的。TLD顶级域名底下可以有很多的域名。比如:"com"这个顶级域名下面会有"google.com"和"ubuntu.com"等域名。子域名是指的一个更大域名底下的那些域名。比如这个例子中的"ubuntu.com"就可以被称作com的一个子域名。我们把其中的ubuntu成为是一个 SLD 二级域名（Second level domain）。

### 主机和子域名的区别
host name主机名和subdomin子域名之间的区别是，  
一个host主机定义了一台计算机或者一个资源。  
而subdomain是继承自父域名。他是一种细分域名本身的方法。  
不管是讨论子域名还是主机host，你都可以发现在一个域名越靠近左侧的部分就越特殊。这就是DNS的工作原理：当你从左往右阅读的时候，就是从特殊到非特殊的过程。

### Name Server 名字服务器
名字服务器是一台设计用来转换域名到IP地址的计算机。这些服务器在DNS域名系统中做很多事情。  
因为这么多数量的域名转换工作如果都让一台服务器来干太多了，因此每台服务器把请求重定向到其他名字服务器或当他们响应时委派响应给他们的子域名。
名字服务器是有"权威性"的，也就是说他们为他们底下控制的域名提供查询域名的答案。否则，他们就指向其他服务器，或者缓存其他名字服务器的数据。

### Zone File 区域文件
一个区域文件是一个简单的文本包含了**域名名字和IP地址之间的映射**。
这也是当用户发起一个具体的域名请求时DNS服务器能够最终找到要联系的IP地址的原因。

区域文件存放在域名服务器上，通常定义了指定域名下可以访问的资源或者能否获得信息的地方。

### Record 记录
在区域文件上，还会有record记录。  
它的最简单的形式——一条记录就是一条从资源到名字的单一映射。  
这样可以映射一个域名到一个IP地址，为域名定义名字服务，为域名定义邮件服务等等。

### Root Server 根服务器
在DNS系统的顶层就是我们所称的根服务器（root server）。这些服务器被各种组织所控制，并有ICANN（互联网名称与数字地址分配机构）授权。

全球目前有**13台根服务器**。然而，因为每分钟有无数的名字要处理，**所以事实上有很多这些服务器的镜像**。有意思的是这些**镜像服务器的IP竟然和单根服务器共享同样的IP地址**。当请求要发送到一台根服务器，这个请求会被**路由到最近的镜像根服务器**上。

那么这些跟服务器都做什么？根服务器处理关于顶级域名信息的请求。因此**如果一个请求在解析服务器的缓存中无法找到**，就会查询域名的根服务器

根服务器实际上并不真的知道域名主机在哪。它们会把请求指向处理指定顶级域名的名字服务器来处理。

所以如果产生了一个发送给根服务器的请求比如"www.wikipedia.org"，根服务器如果在它的record记录中没有找到结果。它会检查它的区域文件查看是否有匹配"www.wikipedia.org"。当然它不会找不到。
相反它会找到一条关于TLD"org"的记录，然后把org地址的名字服务器的地址返回。


### TLD Server 顶级域名服务器
请求者然后发送一条新的请求到新地址（根服务器提供的），这就是顶级域名对这条请求的响应。
所以，为了继续我们的这个例子，它会发送一条请求到名字服务器来响应这个已知的org域名，来查看是否有"www.wikipedia.org"的下落。
这次，请求者会查找它的区域文件。在它的文件记录里还是找不到。
然而，它会找到一条负责"wikipedia.org"这个名字的服务器的IP地址。现在已经离我们想要的答案又近了一步。

### Domain-Level Name Server 域名级名字服务器
此时此刻，请求者已经有了负责处理这个资源的实际IP的名字服务器的IP地址。它发送一条新的请求到这个名字服务器来询问，看这台服务器是否能解决"www.wikipedia.org"。
名字服务器检查他的区域文件，并找到与这个wikipedia.org相关联的一条区域文件。在这个文件中，这里有一条关于"www"host的记录。这条记录里交待了这个主机的具体IP地址。然后名字服务器把最终的答案返回给了请求者。

### 什么是名字解析服务器？
在上面的场景里，我们提到的"请求者"。在这个场景中到底什么是Requester？
在几乎所有的例子中，请求者就是我们所谓的"名字解析服务器"。一台名字解析服务器是一台被配置用来询问其他服务器问题的。对于用户来说它就好比一个中介，**通过缓存之前的查询结果来提高速度，它也知道哪些能够解决他还不知道的相关请求的根服务器的地址**。  
基本上，用户通常很少在他们的电脑上配置域名服务器。**域名解析服务器通常是由ISP或者其他组织来提供的**。比如你可以查询Google提供的DNS服务器。当然这些你可以在你的电脑上自动配置或者手动配置。  
当你在浏览器的地址栏里输入一个URL地址时，你的计算机首先查看本地看资源是否已经定位。**它通过检查计算机上的hosts文件和一些其他定位文件**。然后发起请求到名字解析服务器等待接受资源对应的IP地址。  
名字解析服务器器然后检查检查它的缓存看是否能够找到答案。如果没有找到，然后它就会走之前说的那些步骤。

### Zone File 区域文件
在上面的过程中我们提到了"Zone File"区域文件和"record"记录。
区域文件是用来给名字服务器存储他们所知道的域名信息的的地方。名字服务器知道的每一个域名都存储在一个区域文件中。

> 对于进入到普通名字服务器的大多数请求都不需要服务器通过区域文件来查询。

如果它被配置为递归查询，就像一个名字解析服务器，他会查找到答案并返回。否则，他会告诉请求方下一步应该去哪里查。
一个名字服务器拥有的Zone File 区域文件越多，他需要应答的请求也就越多。

一个区域文件描述一个DNS的区域，这是整个DNS域名系统的子集。它通常被用来配置一个单一的域名。  
它可以包含多条记录用来定义请求中的域名所对应的资源在哪。
默认情况下Zone中的$ORIGIN是一个参数等价于区域中最高权限级别。
所以如果一个区域文件被用来配置一个"example.com."的域名，这个$ORIGIN就要被设置为 example.com. 。
这配置在区域文件的顶部或者也可以定义在DNS服务器配置文件引用区域文件。无论哪种方式，这个参数都表示了这个Zone文件代表的文件。
同样的，$TTL用来配置"time to live"的信息。他基本上是一个定时器。用来表示一个缓存，名字服务器可以使用它之前的查询结果直到TTL时间用完为止。

### Record 记录类型

#### SOA记录
SOA 记录 起始授权，或者SOA记录，在全部的区域文件中是强制性记录。
他必须是文件中的**第一个真实的记录**（尽管 ORIGIN或者TTL会出现在它之上）。它也是最复杂难理解的。

起始授权记录看起来像这样：
```
domain.com.  IN SOA ns1.domain.com. admin.domain.com. (
  12083   ; serial number
  3h      ; refresh interval
  30m     ; retry interval
  3w      ; expiry period
  1h      ; negative TTL
)

```
- domain.com. :这是区域的根。这里指定这个zone文件是给 domain.com. 这个域名的。当然，经常你会看到这里会用@，他是一个占位符替代我们上文中的 $ORIGN。
- IN SOA:"IN"这个部分的意思是internet（在很多记录中会出现）。SOA是指示符用来用来表示这是一个SOA记录。
- ns1.domain.com.:这里定义了这个域名的主名字服务器。名字服务器可以是主服务器或者从服务器。如果动态DNS被配置，那这里就需要一台主服务器。如果你没有配置动态DNS，这里就只是一个你的主名字服务器。
- admin.domain.com.:这里是这个zone区域的管理员的email地址。**email地址中的@被替代为一个点**。如果邮箱地址中有点那么需要使用一个""反斜杠来替代，比如your.name@domain.com（需要写成your\name.domain.com)。
- 12083:这个是zone文件的序列号。**每次你编辑一个zone文件，你必须要要增加一次这个文件的这个数字让它正确传播**。从服务器会检查主服务器的zone文件的序列号是否比他们系统里现有的序列号大。如果是，它就会请求一个新的zone文件，否则就继续使用老的文件。
- 3h:这个是zone文件的刷新间隔周期。从机会等待这个时间周期然后轮询主机，检查zone文件变化。
- 30m: 这是重试zone文件的间隔时间。如果从机在刷新时间到达后无法连接主机，他会等待一段时间并重新尝试轮询主机。
- 3w: 过期时间。如果一个名字服务器从机在这个时间段里无法连接服务器，它就不能作为这个区域的权威来发挥响应
- 1h: 这个时间段是名字服务器缓存一个名字错误的时间量，如果它不能在文件中找到请求的名字。


#### A和AAAA记录
这些记录都映射一个host到一个IP地址。
A记录是被用来应一个host到一个IPv4的IP地址，而AAAAA记录则是用来映射一个host到一个IPv6的地址。

这些记录的常规格式
```
host IN A    IPv4_address
host IN AAAA IPv6_address
domain.com.     IN  A       222.222.222.222  //基础域名解析到的IP地址
*       IN  A       222.222.222.222 //没有明确指明的服务解析到的地址 
```

#### CNAME记录 
CNAME记录定义了一个给定的服务（一个通过A记录或者AAAA记录定义的）名字的别名。
```
server1     IN  A       111.111.111.111
www         IN  CNAME   server1
```
> 需要注意的是这些别名会带来一些性能上的损失，应为他们需要对服务器做额外的查询。绝大多数时候，同样的结果可以通过使用A或者AAAA记录来完成。

只有一种情况下推荐使用CNAME，就是为当前区域以外的资源提供别名。

## Reference
https://juejin.cn/post/6844903795927810061