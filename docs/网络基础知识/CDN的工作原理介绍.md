## CDN 的工作原理介绍

### 加速域名
加速域名指需要使用 CDN 加速的域名。  
加速域名也是一个域名。加速域名一般配置 CNAME 记录，指向 CDN 网络节点。普通域名一般配置 A 记录，指向提供服务的业务服务器。

### 源站
提供原始资源（使用 CDN 加速的资源）的业务服务器，可以指定为域名或 IP 地址。

### 回溯
CDN 节点未缓存资源，或者缓存资源已过期时，回到源站获取资源，返回给客户端。

### 工作原理
假设我建立了一个网站，域名为 www.tt.com，用户访问的主页链接为 www.tt.com/idx.html。  
为了缓解服务端压力和加快访问速度，决定使用阿里云 CDN 服务。 为了更好地理解工作原理，先了解一下 CDN 的接入流程。


#### 接入流程
主要接入步骤如下：

1. 到某域名供应商处申请一个加速域名：js.tt.com。
2. **到阿里云 CDN 平台添加加速域名 js.tt.com，同时设置其源站域名为 www.tt.com。**
3. 阿里云 CDN 平台自动分配一个 CNAME 域名：js.tt.com.ali.com。
4. **到域名供应商处给加速域名 js.tt.com 添加 CNAME 记录，其值为上一步得到的 CNAME 域名：js.tt.com.ali.com**

对以上步骤做进一步说明：

- 为了使用 CDN，必需另外再申请一个加速域名，作为使用 CDN 的入口。
- 加速域名配置的是 CNAME 记录，值为 CDN 平台提供的 CNAME 域名，该 CNAME 域名指向 CDN 系统节点。
- 添加加速域名时需要配置源站域名，据此，CDN 平台保存了加速域名与源站域名的映射关系。
- CNAME 域名的格式一般是：<加速域名> + <供应商主域名>。


### CDN 系统架构
从功能上看，典型的 CDN 系统由**分发服务系统、负载均衡系统和运营管理系**统组成。
- 分发服务系统主要负责资源的响应、缓存和同步。
- 负载均衡系统主要负责对用户请求进行调度。
- 运营管理系统则负责运营需求管理和网络系统管理。  

从节点分布上看，CDN 系统主要分为 **边缘层** 和 **中心层**。边缘层分布在 CDN 网络的边缘位置，给用户提供就近访问服务。   

中心层则负责完成资源同步和运营管理等功能。**中心层保存了加速域名的相关配置信息，比如源站域名，也缓存了加速域名下的各种资源**。在边缘层节点未命中缓存时，需要向中心层节点发起请求；而中心层节点未能命中缓存时，需要查找对应的源站域名，并向该源站域名发起请求。然后再逐层返回并缓存用户请求的资源。


### 就近访问原理
CDN 系统是如何实现就近访问的呢？
CNAME 域名是 CDN 供应商提供的，CDN 供应商拥有对 CNAME 域名的配置权。CDN 供应商会把 CNAME 域名的 NS 记录设置为自己搭建的 DNS 服务器。这样一来，解析 CNAME 域名的时候就会请求 CDN 供应商搭建的 DNS 服务器。

**而 CDN 供应商在 DNS 服务器中实现了负载均衡，会返回离用户较近的边缘层节点的 IP 地址**。如此便实现了就近访问。
DNS 服务器会根据**地理位置和健康状态等信息**返回多个较近的可用的 CDN 边缘节点的 IP 地址。DNS 客户端会选择其中一个 IP 地址作为解析结果，一般是第一个。

## Reference 
https://juejin.cn/post/6844904190913822727