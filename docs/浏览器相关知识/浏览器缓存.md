# 浏览器缓存

浏览器缓存分为两类：强缓存和协商缓存

## 强缓存
强缓存主要使用Expires和Cache-Control两个头字段，如果两者同时存在的时候Cache-Control优先级更高。缓存命中时，会直接从浏览器缓存中读取数据，HTTP状态码返回200。

### Expires
> Response Header: 代表该资源的过期时间。是一个GMT 格式的标准时间。

当客户端请求服务器的时候，服务器会返回资源的同时还会带上响应头Expires，表示资源的过期具体时间，如果客户端在过期时间之前再次获取该资源，就不需要再请求我服务器了，可以直接在缓存里面拿。

#### 使用Expires强缓存优点：
- 在过期时间以内，为用户省了很多流量。

#### 使用Expires强缓存缺点：
- 缓存过期以后，服务器不管文件有没有变化会再次请求服务器。- 缓存过期时间是一个具体的时间，这个时间依赖于客户端的时间，如果时间不准确，缓存效果会随之受到影响。

### Cache-Control
> Request Header/Response Header. 缓存控制字段，精确控制缓存策略。

为了让强缓存更精确，HTTP1.1增加了Cache-Control字段。Cache-Control既能出现在请求头又能出现在响应头，其不同的值代表不同的意思，下面我们具体分析一下。

#### Cache-Control 常用的服务端参数：
- max-age: 在多少秒内有效。这样就不用担心客户端时间不准的问题
- no-cache：不使用本地强缓存。需要使用缓存协商。
- no-store：直接禁止浏览器缓存数据，每次用户请求该资源，都会向服务器发送一个请求，每次都会下载完整的资源。
- public：可以被所有的用户缓存，包括终端用户和中间代理服务器。
- private：只能被终端用户的浏览器缓存，不允许中间缓存代理进行缓存，默认的。

#### Cache-Control 客户端参数：
- max-age: 许多浏览器喜欢用max-age=0来从服务器拿最新的资源
- max-stale: 5 表示客户端到代理服务器上拿缓存的时候，即使代理缓存过期了也不要紧，只要过期时间在 5 秒之内，还是可以从代理中获取的。
- min-fresh: 5 表示代理缓存需要一定的新鲜度，不要等到缓存刚好到期再拿，一定要在到期前 5 秒之前的时间拿，否则拿不到。
- only-if-cached 这个字段加上后表示客户端只会接受代理缓存，而不会接受源服务器的响应。如果代理缓存无效，则直接返回 504（Gateway Timeout）

平时我们常用的主要就是Cache-Control: max-age=86400

## 协商缓存
协商缓存主要有四个头字段，它们两两组合配合使用，If-Modified-Since 和 Last-Modified一组，Etag 和 If-None-Match一组，当同时存在的时候会以Etag 和 If-None-Match为主。当命中协商缓存的时候，服务器会返回HTTP状态码304，让客户端直接从本地缓存里面读取文件。

### If-Modified-Since
> 请求头，资源最近修改时间，由浏览器告诉服务器。默认就是上一次访问服务端返回的Last-Modified的值。

### Last-Modified
> 响应头，资源最近修改时间，由服务器告诉浏览器。

### If-None-Match
> 请求头，缓存资源标识，由浏览器告诉服务器。其实就是上一次访问服务端返回的Etag的值。

### Etag
> 响应头，资源标识，由服务器告诉浏览器。

If-Modified-Since 和 Last-Modified有一个小的缺点，他们只能精确到秒。为了解决这个问题，引入了Etag。Etag 是由文件修改时间与文件大小计算而成，只有当文件文件内容或修改时间变了Etag的值才会发生变化。
